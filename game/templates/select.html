{% load static %}
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DonkMaster 曲選択</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
  <div class="bg-spin"></div>
  <div class="header"></div>
  <div class="song-select">
    <div id="song-list"></div>
    <div id="info" class="info"></div>
    <button class="play" id="play">▶ PLAY</button>
  </div>
  <canvas id="eq" width="800" height="80" class="eq"></canvas>
  <script>
const songs = [
  { slug: "demo", title: "Demo Song", bpm: 150, genre: "Hardbass", artist: "DonkMaster", cover: "{% static 'img/demo.jpg' %}", preview: "{% static 'audio/demo.wav' %}" },
  { slug: "noway", title: "No Way", bpm: 150, genre: "Hardbass", artist: "DJ Gopnik", cover: "{% static 'img/no_way.png' %}", preview: "{% static 'audio/noway_preview.ogg' %}" },
  { slug: "demo2", title: "Demo Song", bpm: 160, genre: "Hardbass", artist: "Anon", cover: "{% static 'img/placeholder.jpg' %}", preview: "{% static 'audio/demo.wav' %}" },
];
let idx = 1; // 中央から開始
const root = document.querySelector('#song-list');
const info = document.querySelector('#info');

let AC, source, analyser, dataArr, previewAudio;
const eq = document.getElementById('eq');
const ectx = eq.getContext('2d');

function ensureAudio(){
  if (AC) return;
  AC = new (window.AudioContext||window.webkitAudioContext)();
  analyser = AC.createAnalyser(); analyser.fftSize = 512;
  dataArr = new Uint8Array(analyser.frequencyBinCount);
  previewAudio = new Audio(); previewAudio.loop = true; previewAudio.crossOrigin = 'anonymous';
  const src = AC.createMediaElementSource(previewAudio);
  src.connect(analyser); analyser.connect(AC.destination);
}

function playPreview(url){
  ensureAudio();
  if (previewAudio.src !== location.origin + url) previewAudio.src = url;
  previewAudio.volume = 0.6;
  previewAudio.play().catch(()=>{/* ユーザ操作後で再生される */});
}

function render(){
  root.innerHTML = '';
  const row = document.createElement('div'); row.className = 'song-row';
  const prev = songs[(idx-1 + songs.length)%songs.length];
  const cur  = songs[idx];
  const next = songs[(idx+1) % songs.length];

  [prev, cur, next].forEach((s, i)=>{
    const div = document.createElement('div');
    div.className = 'song-card ' + (i===0?'prev': i===1?'active':'next');
    div.innerHTML = `
      <img class='cover' src='${s.cover ? s.cover : "{% static 'img/placeholder.jpg' %}"}' alt="${s.title}">
      <div class="title">${s.title}</div>
    `;
    row.appendChild(div);
  });
  // 左右移動ボタン
  const leftBtn = document.createElement('button');
  leftBtn.textContent = '◀';
  leftBtn.className = 'nav-btn left';
  leftBtn.onclick = prev;
  const rightBtn = document.createElement('button');
  rightBtn.textContent = '▶';
  rightBtn.className = 'nav-btn right';
  rightBtn.onclick = next;
  // 曲送りナビボタンを中央エリアに配置
  const navWrap = document.createElement('div');
  navWrap.style.display = 'flex';
  navWrap.style.alignItems = 'center';
  navWrap.style.justifyContent = 'center';
  navWrap.appendChild(leftBtn);
  navWrap.appendChild(row);
  navWrap.appendChild(rightBtn);
  root.appendChild(navWrap);

  info.innerHTML = `
    <div class="line">BPM: <span class="accent">${cur.bpm}</span> | Genre: <span class="accent">${cur.genre}</span></div>
    <div class="line">Artist: <span class="accent">${cur.artist}</span></div>
    <div class="line">Press ⏎ to <span class="accent">PLAY</span></div>
  `;
  playPreview(cur.preview);
}

function next(){ idx = (idx+1)%songs.length; render(); }
function prev(){ idx = (idx-1 + songs.length)%songs.length; render(); }

document.addEventListener('keydown', (e)=>{
  if (e.key === 'ArrowRight') next();
  if (e.key === 'ArrowLeft')  prev();
  if (e.key === 'Enter')      startGame();
});

document.getElementById('play')?.addEventListener('click', startGame);

function startGame(){
  const slug = songs[idx].slug;
  window.location.href = `/play/${encodeURIComponent(slug)}`;
}

function drawEQ(){
  requestAnimationFrame(drawEQ);
  if (!analyser) return;
  analyser.getByteFrequencyData(dataArr);
  const W = eq.width, H = eq.height; ectx.clearRect(0,0,W,H);
  const bars = 48, step = Math.floor(dataArr.length / bars);
  for (let i=0;i<bars;i++){
    const v = dataArr[i*step]/255;
    const h = Math.max(2, v * H);
    const x = (W/bars)*i + 2;
    ectx.fillStyle = `rgba(255,233,0,${0.65 + v*0.35})`;
    ectx.fillRect(x, H-h, (W/bars)-6, h);
  }
}
render(); drawEQ();
  </script>
</body>
</html>
