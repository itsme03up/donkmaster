{% load static %}
<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>曲選択 | DonkMaster</title>
<link rel="stylesheet" href="{% static 'style.css' %}">
</head><body>
<div class="song-select">
  <canvas id="bgfx"></canvas>
  <div class="song-carousel">
    <div class="song prev" id="prev-song"></div>
    <div class="song active" id="active-song">
      <!-- ジャケット or フレーム＋曲名 -->
    </div>
    <div class="song next" id="next-song"></div>
  </div>
  <div class="side-panel" id="side-panel"></div>
  <button class="play-btn" id="play-btn">▶ PLAY</button>
</div>
<audio id="se-tick" src="{% static 'audio/no_way.ogg' %}" preload="auto" style="display:none"></audio>
<script>
// 曲リスト（画像・情報付き）
const songs = [
  { slug: 'demo', title: 'Demo Song', bpm: 150, genre: 'IIDX', artist: 'Test Artist', img: null, color: '#0ff', theme: 'cool' },
  { slug: 'no_way', title: 'No Way', bpm: 150, genre: 'Hardbass', artist: 'DJ Gopnik', img: "{% static 'img/no_way.jpg' %}", color: '#ff0', theme: 'hardbass', flag: 'ru' }
];
let idx = 0;
const prev = document.getElementById('prev-song');
const active = document.getElementById('active-song');
const next = document.getElementById('next-song');
const panel = document.getElementById('side-panel');
const playBtn = document.getElementById('play-btn');
const seTick = document.getElementById('se-tick');
function render() {
  // 前
  const prevIdx = (idx + songs.length - 1) % songs.length;
  prev.innerHTML = songs[prevIdx].img ? `<img src="${songs[prevIdx].img}" alt="${songs[prevIdx].title}"><div>${songs[prevIdx].title}</div>` : `<div class="neon-frame">${songs[prevIdx].title}</div>`;
  // 中央
  const s = songs[idx];
  active.innerHTML = s.img ? `<img src="${s.img}" alt="${s.title}"><h2>${s.title}</h2>` : `<div class="neon-frame"><h2>${s.title}</h2></div>`;
  // BPM/ジャンル/アーティスト/国旗
  let info = `<p>BPM: ${s.bpm} | Genre: ${s.genre}</p><p>Artist: ${s.artist}</p>`;
  if(s.genre==='Hardbass') info += `<span class="flag ${s.flag}"></span>`;
  panel.innerHTML = info;
  // 次
  const nextIdx = (idx + 1) % songs.length;
  next.innerHTML = songs[nextIdx].img ? `<img src="${songs[nextIdx].img}" alt="${songs[nextIdx].title}"><div>${songs[nextIdx].title}</div>` : `<div class="neon-frame">${songs[nextIdx].title}</div>`;
  // 色テーマ
  document.body.className = s.theme;
}
function slide(dir) {
  idx = (idx + dir + songs.length) % songs.length;
  seTick.currentTime = 0; seTick.play();
  render();
}
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') slide(-1);
  if(e.key==='ArrowRight') slide(1);
  if(e.key==='Enter') playBtn.click();
});
document.addEventListener('wheel',e=>{ if(e.deltaY<0) slide(-1); else if(e.deltaY>0) slide(1); });
playBtn.onclick=()=>{ location.href = `/play/${songs[idx].slug}`; };
render();
// BPM同期ストロボ/アナライザー簡易実装
const bgfx = document.getElementById('bgfx');
bgfx.width = window.innerWidth; bgfx.height = window.innerHeight;
const g = bgfx.getContext('2d');
let t = 0;
function anim() {
  t += 1/60;
  const s = songs[idx];
  // ストロボ
  if(s.bpm) {
    const beat = (t * s.bpm / 60) % 1;
    g.clearRect(0,0,bgfx.width,bgfx.height);
    g.fillStyle = beat<0.1 ? s.color : '#111';
    g.fillRect(0,0,bgfx.width,8);
    // EQ風
    for(let i=0;i<20;i++){
      const h = Math.abs(Math.sin(t*2+i))*40+20;
      g.fillStyle = s.color;
      g.fillRect(30+i*20,bgfx.height-60-h,12,h);
    }
  }
  requestAnimationFrame(anim);
}
anim();
</script>
</body></html>
